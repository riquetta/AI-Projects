name: Python Dependency Scan

on:
  push:
    paths:
      - "base-app/**"
      - ".github/workflows/deps-scan.yml"
  pull_request:
    paths:
      - "base-app/**"
  schedule:
    - cron: "0 6 * * 1"  # Weekly Monday 06:00 UTC scan

permissions:
  contents: read
  security-events: write   # required to upload SARIF to code scanning
  actions: read

jobs:
  pip-audit:
    name: pip-audit (deps)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: base-app

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('base-app/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install app dependencies (no dev extras)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Generate a lockfile on the fly to make resolution deterministic for the audit.
      # If you already have a compiled requirements (e.g., requirements.lock.txt), point pip-audit at it.
      - name: Create resolved requirements (freeze)
        run: |
          pip freeze --local | sort > resolved-requirements.txt

      - name: Run pip-audit (fail on vulns and emit SARIF)
        # --strict makes nonzero exit on any vulnerability
        run: |
          python -m pip install pip-audit
          pip-audit -r resolved-requirements.txt --progress-spinner off \
            --format sarif -o pip-audit-results.sarif --strict

      - name: Upload SARIF to code scanning
        if: always()  # upload even if the previous step failed
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: base-app/pip-audit-results.sarif