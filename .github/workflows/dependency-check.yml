name: Dependency Vulnerability Scan

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: read

concurrency:
  group: dependency-scan-${{ github.ref }}
  cancel-in-progress: true

jobs:
  python-deps:
    name: Python Dependency Scan (pip-audit)
    runs-on: ubuntu-latest

    steps:
      # ----------------------------
      # Checkout code
      # ----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------
      # Setup Python
      # ----------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # ----------------------------
      # Determine if dependency files exist
      # ----------------------------
      - name: Check for dependency files
        id: deps
        run: |
          FILES_CHANGED=0
          if [ -f base-app/requirements.txt ] || [ -f base-app/poetry.lock ] || [ -f base-app/Pipfile.lock ]; then
            FILES_CHANGED=1
          fi
          echo "changed=$FILES_CHANGED" >> $GITHUB_OUTPUT

      # ----------------------------
      # Install pip-audit and run scan
      # ----------------------------
      - name: Run pip-audit
        if: steps.deps.outputs.changed == '1'
        working-directory: base-app
        shell: bash
        run: |
          set -euo pipefail
          REPORT_DIR="../reports/python"
          mkdir -p "$REPORT_DIR"

          pip install --upgrade pip pip-audit

          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
            pip-audit -r requirements.txt -f json -o "$REPORT_DIR/pip-audit.json"
            pip-audit -r requirements.txt -f sarif -o "$REPORT_DIR/pip-audit-results.sarif" --strict
          elif [ -f poetry.lock ]; then
            pip install poetry
            poetry export -f requirements.txt -o exported-requirements.txt --without-hashes
            pip install -r exported-requirements.txt
            pip-audit -r exported-requirements.txt -f json -o "$REPORT_DIR/pip-audit.json"
            pip-audit -r exported-requirements.txt -f sarif -o "$REPORT_DIR/pip-audit-results.sarif" --strict
          elif [ -f Pipfile.lock ]; then
            pip install pipenv
            pipenv requirements > exported-requirements.txt
            pip install -r exported-requirements.txt
            pip-audit -r exported-requirements.txt -f json -o "$REPORT_DIR/pip-audit.json"
            pip-audit -r exported-requirements.txt -f sarif -o "$REPORT_DIR/pip-audit-results.sarif" --strict
          else
            echo "No dependency files found in base-app/"
          fi

      # ----------------------------
      # Upload JSON and SARIF reports as artifacts
      # ----------------------------
      - name: Upload Python dependency reports
        if: steps.deps.outputs.changed == '1'
        uses: actions/upload-artifact@v4
        with:
          name: python-dependency-reports
          path: reports/python/

      # ----------------------------
      # Upload SARIF for GitHub Dependency Scanning
      # ----------------------------
      - name: Upload pip-audit SARIF to GitHub
        if: steps.deps.outputs.changed == '1'
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: reports/python/pip-audit-results.sarif
